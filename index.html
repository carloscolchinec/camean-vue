<!DOCTYPE html>
<html>
<head>
  <title>Lector de Código de Barras</title>
  <style>
    #app {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      background-color: #f5f5f5;
    }
    .camera-view {
      position: relative;
      width: 320px;
      height: 240px;
      border: 1px solid #ccc;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .detected-rectangle {
      position: absolute;
      border: 2px solid red;
      pointer-events: none;
    }
    .barcode-number {
      position: absolute;
      top: 5px;
      left: 5px;
      background-color: red;
      color: white;
      padding: 2px 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="camera-view">
      <video ref="cameraVideo" playsinline="true"></video>
      <canvas ref="cameraOverlay" width="320" height="240"></canvas>
    </div>
    <select v-if="cameras.length > 0" v-model="selectedCamera" @change="restartScanner">
      <option v-for="(camera, index) in cameras" :key="index" :value="index">
        {{ camera.label }}
      </option>
    </select>
  </div>

  <script src="https://unpkg.com/vue@3.2.25/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    Vue.createApp({
      data() {
        return {
          cameras: [],
          selectedCamera: null,
          scannerActive: false,
        };
      },
      async mounted() {
        await this.initCamera();
        this.restartScanner();
      },
      watch: {
        selectedCamera() {
          this.restartScanner();
        },
      },
      methods: {
        async initCamera() {
          try {
            this.scannerActive = false;
            const codeReader = new ZXing.BrowserBarcodeReader();
            this.cameras = await this.getAvailableCameras();

            if (this.cameras.length > 0) {
              this.selectedCamera = 0;
            } else {
              alert("No se encontraron cámaras disponibles.");
            }
          } catch (err) {
            console.error("Error al acceder a la cámara:", err);
            alert("No se pudo acceder a la cámara o el acceso fue denegado por el usuario.");
          }
        },
        async getAvailableCameras() {
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            return devices.filter((device) => device.kind === "videoinput");
          } catch (err) {
            console.error("Error al obtener las cámaras:", err);
            return [];
          }
        },
        async startScanner() {
          const cameraVideo = this.$refs.cameraVideo;
          const cameraOverlay = this.$refs.cameraOverlay;
          const barcodeNumber = document.createElement("div");
          const canvasContext = cameraOverlay.getContext("2d");
          this.scannerActive = true;

          cameraVideo.srcObject = null;
          const selectedDeviceId = this.cameras[this.selectedCamera].deviceId;
          const constraints = { video: { deviceId: selectedDeviceId } };

          try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraVideo.srcObject = stream;
            await cameraVideo.play();
          } catch (err) {
            console.error("Error al acceder a la cámara:", err);
            this.scannerActive = false;
            alert("No se pudo acceder a la cámara o el acceso fue denegado por el usuario.");
            return;
          }

          cameraOverlay.appendChild(barcodeNumber);
          barcodeNumber.classList.add("barcode-number");

          async function scanBarcode() {
            if (!this.scannerActive) return;

            try {
              const result = await codeReader.decodeFromVideoElement(
                cameraVideo,
                cameraVideo.width,
                cameraVideo.height
              );

              if (result && result.text) {
                drawDetectedBarcode(result.text);
              }

              // Continuar escaneando
              scanBarcode.call(this);
            } catch (err) {
              console.error("Error al escanear:", err);
            }
          }

          // Iniciar el escaneo automáticamente
          scanBarcode.call(this);
        },
        stopScanner() {
          this.scannerActive = false;
        },
        restartScanner() {
          this.stopScanner();
          this.startScanner();
        },
      },
    }).mount("#app");
  </script>
</body>
</html>
